rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if updating only password reset fields
    function isPasswordResetUpdate() {
      let allowedFields = ['passwordResetCode', 'passwordResetCodeExpiry'];
      let updateFields = request.resource.data.diff(resource.data).affectedKeys();
      return updateFields.hasOnly(allowedFields);
    }
    
    // ============================================
    // USERS COLLECTION RULES
    // ============================================
    match /users/{userId} {
      // Allow create during sign up (initial user creation)
      allow create: if request.auth != null && 
        request.auth.uid == userId;
      
      // Allow read if user is authenticated and is the owner
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Allow query by email for password reset (unauthenticated)
      // This is needed to check if email exists and send reset code
      allow read: if request.query.limit == 1;
      
      // Allow update if user is authenticated and is the owner
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Allow password reset field updates (unauthenticated)
      // Only allows updating passwordResetCode and passwordResetCodeExpiry fields
      allow update: if isPasswordResetUpdate();
      
      // Allow delete if user is authenticated and is the owner
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // ADMINS COLLECTION RULES
    // ============================================
    match /admins/{adminId} {
      // Allow create during sign up (initial admin creation)
      allow create: if request.auth != null && 
        request.auth.uid == adminId;
      
      // Allow read if user is authenticated and is the owner
      allow read: if request.auth != null && request.auth.uid == adminId;
      
      // Allow query by email for password reset (unauthenticated)
      // This is needed to check if email exists and send reset code
      allow read: if request.query.limit == 1;
      
      // Allow update if user is authenticated and is the owner
      allow update: if request.auth != null && request.auth.uid == adminId;
      
      // Allow password reset field updates (unauthenticated)
      // Only allows updating passwordResetCode and passwordResetCodeExpiry fields
      allow update: if isPasswordResetUpdate();
      
      // Allow delete if user is authenticated and is the owner
      allow delete: if request.auth != null && request.auth.uid == adminId;
    }
    
    // ============================================
    // REPORTS COLLECTION RULES
    // ============================================
    match /reports/{reportId} {
      // Users can create reports with their own userId
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // Users can read their own reports
      // Admins can read all reports (check via custom claim or admin collection)
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
      );
      
      // Only admins can update reports
      allow update: if request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      
      // Only admins can delete reports
      allow delete: if request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ============================================
    // SCHEDULES COLLECTION RULES
    // ============================================
    match /schedules/{scheduleId} {
      // Any authenticated user can read schedules
      allow read: if request.auth != null;
      
      // Any authenticated user can create/update/delete schedules
      allow create, update, delete: if request.auth != null;
    }
    
    // ============================================
    // AUDIT LOGS COLLECTION RULES
    // ============================================
    match /audit_logs/{logId} {
      // Admins can read all audit logs
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      
      // Any authenticated user can create audit logs
      allow create: if request.auth != null;
      
      // Allow unauthenticated audit log creation for security events
      // (like failed login attempts, password reset requests)
      allow create: if true;
    }
    
    // ============================================
    // SECURITY ATTEMPTS COLLECTION RULES
    // ============================================
    match /security_attempts/{emailDoc} {
      // Allow READ for everyone (needed to check if account is locked BEFORE authentication)
      allow read: if true;
      
      // Allow creating and updating security attempt records
      allow create, update: if true;
      
      // Note: We allow broad access here because:
      // 1. Lock checks happen BEFORE user authenticates
      // 2. Failed attempt tracking must work for invalid credentials
      // 3. Document IDs are sanitized emails, not sensitive data
      // 4. Actual security is enforced in the application code
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION RULES
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      
      // Any authenticated user can create notifications
      allow create: if request.auth != null && 
        request.resource.data.userId is string &&
        request.resource.data.containsKey('createdAt') &&
        request.resource.data.containsKey('isRead');
      
      // Users can update their own notifications (mark as read, etc.)
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['userId', 'createdAt']);
      
      // Users can delete their own notifications
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // DEFAULT DENY FOR ALL OTHER COLLECTIONS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
